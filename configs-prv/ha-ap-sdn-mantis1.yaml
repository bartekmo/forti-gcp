# This configuration deploys a cluster for demonstrating the problem with HA failover and route rewrite

imports:
- path: https://raw.githubusercontent.com/40net-cloud/fortinet-gcp-solutions/refactor/gcp-dm/fortigate/ha-ap.jinja
  name: ha-ap.jinja


resources:
# first, let's prepare two networks...
- name: mantis-gcp-sdn-ha-protected-vpc
  type: compute.v1.network
  properties:
    autoCreateSubnetworks: false
- name: mantis-gcp-sdn-ha-external-vpc
  type: compute.v1.network
  properties:
    autoCreateSubnetworks: false
# ...and some subnets
- name: mantis-gcp-sdn-ha-protected-subnet
  type: compute.v1.subnetwork
  properties:
    region: us-west1
    network: $(ref.mantis-gcp-sdn-ha-protected-vpc.selfLink)
    ipCidrRange: 172.17.0.0/24
- name: mantis-gcp-sdn-ha-external-subnet
  type: compute.v1.subnetwork
  properties:
    region: us-west1
    network: $(ref.mantis-gcp-sdn-ha-external-vpc.selfLink)
    ipCidrRange: 172.17.1.0/24
# Now it's time to deploy a Fortigates and protect the internalVpc
# Note how you can skip some properties leaving them to default (e.g. licensing)
# and declare only those you want to change (e.g. instanceType)
- name: fortigate-cluster
  type: ha-ap.jinja
  properties:
    region: us-west1
    zones:
    - us-west1-b
    - us-west1-c
    instanceType: e2-highcpu-4
    version: 6.4.1
    networks:
      internal:
        vpc: $(ref.mantis-gcp-sdn-ha-protected-vpc.selfLink)
        subnet: $(ref.mantis-gcp-sdn-ha-protected-subnet.selfLink)
        ipCidrRange: 172.17.0.0/24
      external:
        vpc: $(ref.mantis-gcp-sdn-ha-external-vpc.selfLink)
        subnet: $(ref.mantis-gcp-sdn-ha-external-subnet.selfLink)
        ipCidrRange: 172.17.1.0/24
    routes:
    - name: test
      destRange: 0.0.0.0/0
      tags:
      - test-only-tag
      description: This is a disappearing test description
